<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en-us" lang="en-us">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2005"/>
<meta name="DC.rights.owner" content="(C) Copyright 2005"/>
<meta name="DC.Type" content="reference"/>
<meta name="DC.Title" content="SPL File TestIPAddressLocationGeohash.spl"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="spldoc_compilationunit"/>
<link rel="stylesheet" type="text/css" href="../../html/commonltr.css"/>
<link rel="stylesheet" type="text/css" href="../../html/spldoc.css"/>
<title>SPL File TestIPAddressLocationGeohash.spl</title>
</head>
<body id="spldoc_compilationunit">


<h1 class="title topictitle1">SPL File <tt class="ph tt">TestIPAddressLocationGeohash.spl</tt></h1>

<div class="body refbody">
<div class="section">
<p class="p">
<a class="xref" href="../toolkits/toolkits.html">Toolkits</a> &gt; <a class="xref" href="tk$SampleIPAddressLocation.html">SampleIPAddressLocation 1.0.0</a> &gt; <a class="xref" href="ns$sample.html">sample</a> &gt; TestIPAddressLocationGeohash.spl</p>

</div>

<div class="section"><h2 class="title sectiontitle splhead-1">Content</h2>
  
  <dl class="dl">
    <dt class="dt dlterm"/>
<dd class="dd"/>

    
      <dt class="dt dlterm splhead-2">Operators</dt>

      <dd class="dd">
<ul class="sl simple">
<li class="sli"><strong class="ph b"><a class="xref" href="spl$sample$TestIPAddressLocationGeohash.html#spldoc_compilationunit__composite_operator__TestIPAddressLocationGeohash">TestIPAddressLocationGeohash</a></strong>
</li>

</ul>

      </dd>

    
    
      <dt class="dt dlterm splhead-2">Functions</dt>

      <dd class="dd">
<ul class="sl simple">
<li class="sli"><strong class="ph b"><a class="xref" href="spl$sample$TestIPAddressLocationGeohash.html#spldoc_compilationunit__function__loadGeohashTable.rstring">loadGeohashTable(rstring)</a></strong>
</li>

</ul>

      </dd>

    
    
      <dt class="dt dlterm splhead-2">Types</dt>

      <dd class="dd">
<ul class="sl simple">
<li class="sli"><strong class="ph b"><a class="xref" href="spl$sample$TestIPAddressLocationGeohash.html#spldoc_compilationunit__type__GeohashType">GeohashType</a></strong>
</li>

</ul>

      </dd>

    
  </dl>

</div>

<div class="section"><h2 class="title sectiontitle splhead-1">Composites</h2>
  
</div>

<div class="section" id="spldoc_compilationunit__composite_operator__TestIPAddressLocationGeohash"><h2 class="title sectiontitle splpart">public composite TestIPAddressLocationGeohash</h2>
  
</div>

<div class="section splgraph">
  <embed class="image" src="../../image/tk$SampleIPAddressLocation/op$sample$TestIPAddressLocationGeohash.svg" width="452" height="175"/>
</div>

<div class="section"><h2 class="title sectiontitle">Parameters</h2>

<ul class="sl simple">
<li class="sli"><strong class="ph b">geographyDirectory</strong>
</li>

<li class="sli"><strong class="ph b">pcapFilename</strong>
</li>

<li class="sli"><strong class="ph b">geohashFilename</strong>
</li>

</ul>

</div>

<div class="section">
</div>

<div class="section">
</div>

<div class="section"><h2 class="title sectiontitle splhead-2">SPL Source Code</h2>
  
</div>


<div class="section">
   <pre class="pre codeblock">

 composite TestIPAddressLocationGeohash {
 
     param
     expression&lt;rstring&gt; $geographyDirectory: getSubmissionTimeValue("geographyDirectory", "./www.maxmind.com" );
     expression&lt;rstring&gt; $pcapFilename: getSubmissionTimeValue("pcapFilename", "../../SampleNetworkToolkitData/data/sample_locations_ipv4_only.pcap" );
     expression&lt;rstring&gt; $geohashFilename: getSubmissionTimeValue("geohashFilename", "../../SampleNetworkToolkitData/data/geohashes.csv" );
 
     type
 
     PacketType =
         uint64 packetNumber,                // sequence number of packet, as emitted by operator
         float64 captureTime,                // time that packet was captured, in seconds since Unix epoch
         uint32 ipSourceAddress,             // IPv4 source address, or empty if not IPv4 packet
         uint16 ipSourcePort,                // IP source port, or zero if not UDP or TCP packet
         uint32 ipDestinationAddress,        // IPv4 destination address, or empty if not IPv4 packet
         uint16 ipDestinationPort,           // IP destination port, or zero if not UDP or TCP packet
         uint32 packetLength;                // original length of packet (not necessarily all captured)
 
     EndpointGeohashType =
         uint64 packetNumber,               // sequence number of packet, as emitted by operator
         float64 captureTime,               // time that packet was captured, in seconds since Unix epoch
         rstring ipSourceAddress,  
         rstring ipSourceSubnet,  
         rstring ipSourceLabel,
         rstring ipSourceGeohash,
         rstring ipDestinationAddress,  
         rstring ipDestinationSubnet,  
         rstring ipDestinationLabel,
         rstring ipDestinationGeohash;
 
     EndpointLocationType =
         uint64 packetNumber,               // sequence number of packet, as emitted by operator
         float64 captureTime,               // time that packet was captured, in seconds since Unix epoch
         rstring ipSourceAddress,  
         rstring ipSourceSubnet,  
         rstring ipSourceLabel,
         rstring ipSourceGeohash,
         float64 sourceLatitude,
         float64 sourceLongitude,
         rstring sourceCountry,
         rstring sourceDivision,
         rstring sourceCity,
         rstring ipDestinationAddress,  
         rstring ipDestinationSubnet,  
         rstring ipDestinationLabel,
         rstring ipDestinationGeohash,
         float64 destinationLatitude,
         float64 destinationLongitude,
         rstring destinationCountry,
         rstring destinationDivision,
         rstring destinationCity;
 
     graph
 
     stream&lt;PacketType&gt; PacketStream as Out = PacketFileSource() {
         param
             pcapFilename: $pcapFilename;
             outputFilters: IP_VERSION()==4ub;
         output Out:
             packetNumber = packetsProcessed() - 1ul,
             captureTime = (float64)CAPTURE_SECONDS() + (float64)CAPTURE_MICROSECONDS() / 1000000.0,
             ipSourceAddress = IPV4_SRC_ADDRESS(),
             ipSourcePort = IP_SRC_PORT(),
             ipDestinationAddress = IPV4_DST_ADDRESS(),
             ipDestinationPort = IP_DST_PORT(),
             packetLength = PACKET_LENGTH(); }
     () as PacketSink = FileSink(PacketStream) { param file: "debug.TestIPAddressLocationGeohash.PacketStream.out"; format: txt; hasDelayField: true; flush: 1u; }
 
 
     stream&lt;EndpointGeohashType&gt; EndpointGeohashStream as Out = IPAddressLocation(PacketStream) {
       param
         geographyDirectory: $geographyDirectory;
         outputFilters: locationCityName(ipSourceAddress)!="" || locationCityName(ipDestinationAddress)!="";
       output Out:
         ipSourceAddress = convertIPV4AddressNumericToString(ipSourceAddress),
         ipSourceSubnet = locationSubnet(ipSourceAddress),
         ipSourceLabel = locationCityName(ipSourceAddress) + ", " + locationSubdivision1Name(ipSourceAddress) + ", " + locationCountryName(ipSourceAddress),
         ipSourceGeohash = locationGeohash(ipSourceAddress,6),
         ipDestinationAddress = convertIPV4AddressNumericToString(ipDestinationAddress),
         ipDestinationSubnet = locationSubnet(ipDestinationAddress),
         ipDestinationLabel = locationCityName(ipDestinationAddress) + ", " + locationSubdivision1Name(ipDestinationAddress) + ", " + locationCountryName(ipDestinationAddress),
         ipDestinationGeohash = locationGeohash(ipDestinationAddress,6); }
     () as EndpointGeohashSink = FileSink(EndpointGeohashStream) { param file: "debug.TestIPAddressLocationGeohash.EndpointGeohashStream.out"; format: txt; hasDelayField: true; flush: 1u; }
 
 
     stream&lt;EndpointLocationType&gt; EndpointLocationStream as Out = Custom(EndpointGeohashStream as In) {
       logic state: {
         map&lt;rstring,GeohashType&gt; geohashTable = loadGeohashTable($geohashFilename); }
       onTuple In: {
         mutable EndpointLocationType outTuple = {};
         assignFrom(outTuple, In);
         if (ipSourceGeohash in geohashTable) { 
           GeohashType location = geohashTable[ipSourceGeohash];
           outTuple.sourceLatitude = location.latitude;
           outTuple.sourceLongitude = location.longitude;
           outTuple.sourceCountry = location.country;
           outTuple.sourceDivision = location.division;
           outTuple.sourceCity = location.city; }
         if (ipDestinationGeohash in geohashTable) { 
           GeohashType location = geohashTable[ipDestinationGeohash];
           outTuple.destinationLatitude = location.latitude;
           outTuple.destinationLongitude = location.longitude;
           outTuple.destinationCountry = location.country;
           outTuple.destinationDivision = location.division;
           outTuple.destinationCity = location.city; }
         submit(outTuple, Out); } }
     () as EndpointLocationSink = FileSink(EndpointLocationStream) { param file: "debug.TestIPAddressLocationGeohash.EndpointLocationStream.out"; format: txt; hasDelayField: true; flush: 1u; }
 
 }

   </pre>

</div>

<div class="section"><h2 class="title sectiontitle splhead-1">Functions</h2>
  
</div>

<div class="section" id="spldoc_compilationunit__function__loadGeohashTable.rstring"><h2 class="title sectiontitle splpart">map&lt;rstring, GeohashType&gt; loadGeohashTable(rstring filename)</h2>
  
</div>
<div class="section"><h2 class="title sectiontitle">Parameters</h2>

 <ul class="sl simple">
   <li class="sli">
<strong class="ph b">filename</strong>
   </li>

 </ul>

</div>

<div class="section"><h2 class="title sectiontitle">Returns</h2>

<ul class="sl simple"><li class="sli">
<tt class="ph tt">map&lt;rstring, GeohashType&gt;</tt>
</li>
</ul>

</div>

<div class="section"><h2 class="title sectiontitle splhead-2">SPL Source Code</h2>
  
</div>

<div class="section">
   <pre class="pre codeblock">

 stateful map&lt;rstring,GeohashType&gt; loadGeohashTable(rstring filename) {
 
   mutable map&lt;rstring,GeohashType&gt; table = {};
   mutable int32 error = 0;
   mutable boolean header = true;
 
   appTrc(Trace.info, "loading geohash table from file " + filename + " ..."); 
 
   uint64 file = fopen(filename, "r", error);
   if (error!=0) { appLog(Log.error, "sorry, could not open file " + filename + ", " + strerror(error)); abort(); }
 
   mutable int32 counter = 0;
   while (true) {
 
     rstring line = freadLine(file, error);
     if (feof(file)) break;
     if (error!=0) { appLog(Log.error, "sorry, could not read file " + filename + ", " + strerror(error)); abort(); }
 
     //printStringLn(line);
     counter++;
     if (header) { header = false; continue; }
     
     list&lt;rstring&gt; tokens = csvTokenize(line);
     if (size(tokens)!=11) { appLog(Log.error, "sorry, unexpected number of tokens in line '" + line + "' of file " + filename); abort(); }
     if (length(tokens[1])==0 || length(tokens[2])==0) { continue; }
   
     GeohashType location = { geohash=tokens[0], latitude=(float64)tokens[1], longitude=(float64)tokens[2], country=tokens[5], division=tokens[7], city=tokens[10] };
     table[tokens[0]] = location;
   }
 
   fclose(file, error);
 
   appTrc(Trace.info, "... loaded " + (rstring)(size(keys(table))) + " of " + (rstring)counter + " geohashes from file " + filename); 
   return table;
 }

   </pre>

</div>

<div class="section"><h2 class="title sectiontitle splhead-1">Types</h2>
  
</div>

<div class="section" id="spldoc_compilationunit__type__GeohashType"><h2 class="title sectiontitle splpart">GeohashType</h2>
  
</div>
<div class="section">
   <p class="p">
<tt class="ph tt">GeohashType = rstring geohash, float64 latitude, float64 longitude, rstring country, rstring division, rstring city;</tt>
   </p>

</div>

</div>


</body>
</html>